# .github/workflows/publish-cli.yml
name: Publish CLI on Release PR Merge

on:
  pull_request:
    types: [closed] # Trigger when a PR is closed
    branches: [ main ] # Only on PRs targeting the main branch
  workflow_dispatch: # Keep manual trigger for specific cases (like initial v0.5.0)
    inputs:
      version_type:
        description: 'Specify bump type (patch, minor, major) OR exact version (e.g., 0.5.0)'
        required: true
      reason:
        description: 'Reason for manual trigger (e.g., Initial v0.5.0 release)'
        required: true

permissions:
  contents: write # To push version bump commit and tag, and read PR labels
  pull-requests: read # To read PR labels and check merge status
  id-token: write # To publish to NPM using OIDC (or use secrets.NPM_TOKEN)

jobs:
  publish_cli_on_merge:
    # Run only if PR was merged AND had a release label AND contained release-relevant changes (src/, .npmignore, or package.json)
    # OR if it was a manual trigger
    # Note: Label checking is done in the step, not here, to avoid expression syntax issues
    if: |
      (
        github.event.pull_request.merged == true
      ) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.set_version.outputs.version }} # Pass version out if needed later

    steps:
      - name: Checkout code on target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name || github.base_ref || 'main' }} # Use the current branch for manual triggers, target branch for PRs
          fetch-depth: 0 # Fetch full history for versioning/tagging
          # Note: GH_PAT secret is optional. If not set, checkout uses GITHUB_TOKEN by default.
          # Set GH_PAT secret to bypass branch protection rules when pushing.
          token: ${{ secrets.GH_PAT }}

      # --- Logic for PR Trigger ---
      - name: Check for release-relevant changes in PR (PR Trigger Only)
        id: check_pr_files
        if: github.event_name == 'pull_request'
        run: |
          # Get files changed in the PR
          PR_FILES=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.event.pull_request.url }}/files" | jq -r '.[].filename')

          echo "Files changed in PR: $PR_FILES"
          # Check for changes in src/, .npmignore, or package.json (all trigger releases)
          RELEASE_RELEVANT=$(echo "$PR_FILES" | grep -qE '^(src/|\.npmignore|package\.json)' && echo "true" || echo "false")
          echo "release_relevant=$RELEASE_RELEVANT" >> $GITHUB_OUTPUT

      - name: Determine Version Bump Type from Label (PR Trigger Only)
        id: get_label
        if: github.event_name == 'pull_request' && steps.check_pr_files.outputs.release_relevant == 'true'
        run: |
          # Get PR labels from GitHub API
          PR_LABELS=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.event.pull_request.url }}/labels" | jq -r '.[].name')
          
          echo "PR Labels: $PR_LABELS"
          
          VERSION_TYPE=""
          if echo "$PR_LABELS" | grep -q "release:major"; then
            VERSION_TYPE="major"
          elif echo "$PR_LABELS" | grep -q "release:minor"; then
            VERSION_TYPE="minor"
          elif echo "$PR_LABELS" | grep -q "release:patch"; then
            VERSION_TYPE="patch"
          fi
          
          # Check if exactly one release label was found
          if [[ -z "$VERSION_TYPE" ]]; then
             echo "Error: PR must have exactly one release:* label (patch, minor, or major)."
             exit 1
          fi
          
          # Check for multiple release labels (error case)
          LABEL_COUNT=$(echo "$PR_LABELS" | grep -c "release:" || echo "0")
          if [[ "$LABEL_COUNT" -ne 1 ]]; then
             echo "Error: PR must have exactly one release:* label (patch, minor, or major). Found $LABEL_COUNT release labels."
             exit 1
          fi
          
          echo "Detected version type from label: $VERSION_TYPE"
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

      # --- Setup Node & Git ---
      - name: Setup Node.js
        # Run if manual trigger OR (PR trigger AND release-relevant changes AND label found)
        if: github.event_name == 'workflow_dispatch' || steps.get_label.outputs.version_type != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git user
        if: github.event_name == 'workflow_dispatch' || steps.get_label.outputs.version_type != ''
        env:
          # Note: GH_PAT secret is optional. If not set, git push will use GITHUB_TOKEN (may fail with branch protection)
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use PAT for pushing (bypasses branch protection)
          # If GH_PAT is not set, git will use the token from checkout action
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin https://${GH_PAT}@github.com/${{ github.repository }}.git
          fi

      - name: Install dependencies
        if: github.event_name == 'workflow_dispatch' || steps.get_label.outputs.version_type != ''
        run: npm ci

      # --- Versioning & Tagging ---
      - name: Bump version, Commit, Tag, Push
        id: set_version
        if: github.event_name == 'workflow_dispatch' || steps.get_label.outputs.version_type != ''
        run: |
          VERSION_INPUT=""
          # Determine version type/value based on trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION_INPUT="${{ github.event.inputs.version_type }}"
          else # pull_request trigger
            VERSION_INPUT="${{ steps.get_label.outputs.version_type }}"
          fi

          echo "Attempting version action with input: $VERSION_INPUT"

          # Check if input is a specific version or a bump type
          if [[ "$VERSION_INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            # Input is an exact version (e.g., 0.5.0) - Likely for manual trigger
            echo "Input is an exact version: $VERSION_INPUT"
            # Ensure package.json matches this version before tagging
            CURRENT_PKG_VERSION=$(node -p "require('./package.json').version")
            if [[ "$CURRENT_PKG_VERSION" != "$VERSION_INPUT" ]]; then
               echo "Error: Manual version $VERSION_INPUT does not match package.json version $CURRENT_PKG_VERSION. Make sure package.json was updated manually."
               exit 1
            fi
            # Manually create tag
            echo "Creating tag v${VERSION_INPUT}"
            git tag "v${VERSION_INPUT}"
            git push origin "v${VERSION_INPUT}"
            NEW_VERSION=$VERSION_INPUT
          elif [[ "$VERSION_INPUT" =~ ^(patch|minor|major)$ ]]; then
            # Input is a bump type (patch, minor, major) - Likely for PR trigger
            echo "Input is a bump type: $VERSION_INPUT. Performing npm version $VERSION_INPUT..."
            # npm version <type> bumps, commits, tags (vX.Y.Z), and pushes
            npm version "$VERSION_INPUT" -m "chore(release): bump CLI version to %s [skip ci]"
            echo "Pushing commit and tag..."
            git push --follow-tags
            NEW_VERSION=$(node -p "require('./package.json').version")
          else
            echo "Error: Invalid version input '$VERSION_INPUT'. Must be 'patch', 'minor', 'major', or an exact version like 'X.Y.Z'."
            exit 1
          fi

          echo "Set version to: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # --- Publishing ---
      - name: Publish to NPM
        if: github.event_name == 'workflow_dispatch' || steps.get_label.outputs.version_type != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public